name: PR Checks

on:
  pull_request:
    branches: ["**"]

jobs:
  validate-branch:
    name: Validate Target Branch
    runs-on: ubuntu-latest
    steps:
      - name: YOU SHALL NOT PASS
        if: github.base_ref == 'main'
        run: |
          if [ "${{ github.head_ref }}" != "develop" ]; then
            echo "ERROR: Pull requests to 'main' are not allowed."
            echo "Current source branch: ${{ github.head_ref }}"
            echo ""
            echo "Please create a PR to 'develop' first, this will become a release candidate when merged into 'main' by a maintainer"
            exit 1
          fi
          echo "Valid PR: develop â†’ main"

      - name: PR info
        run: |
          echo "PR validation passed"
          echo "Source: ${{ github.head_ref }}"
          echo "Target: ${{ github.base_ref }}"

  tests:
    name: Tests now - BOOORING
    runs-on: ubuntu-latest
    needs: validate-branch
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup the best engine ever
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install all dependencies
        run: yarn install --frozen-lockfile

      - name: You better have linting rules in your vscode
        run: yarn lint

      - name: This will totally fail if you only use AI
        run: yarn tsc --noEmit

      - name: As important as boring security tests
        run: yarn test:run tests/security --reporter=verbose

      - name: Api tests so JotTick keeps working lmfao
        run: yarn test:run tests/api --reporter=verbose

      - name: Server actions also need to be tested
        run: yarn test:run tests/server-actions --reporter=verbose
